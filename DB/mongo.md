# 漫谈MongoDB
### 认识MongoDB
MongoDB是一个面向文档的数据库,而不是关系型数据库。MongoDB作为一款通用型数据库,除了能够创建、读取、更新和删除数据之外,还提供一系列不断扩展的独特功能。

### MongoDB概念
- 集合(collection)可以看作是一个拥有动态模式的表
- 文档是MongoDB中数据的基本单元,类似于关系型数据库管理系统中的行
- 文档的键(key)和值(value)不再是固定的类型和大小
- 每一个文档都有一个特殊的键"_id", 这个键在文档所属的集合中是唯一的

#### 文档
文档就是键值对的一个有序集。
- 文档的键是字符串
- 键不能含有\0(空字符)
- .和$只能在特定环境下使用
- MongoDB不但区分类型,而且区分大小写
- MongoDB的文档不能有重复的键

#### 集合
集合就是一组文档。
- 集合是动态模式的，一个集合里面的文档可以是各式各样的
- 集合名不能是空字符串("")
- 集合名不能包含\0字符(空字符)
- 集合名不能以“system.”开头,这是为系统集合保留的前缀
- 用户创建的集合不能在集合名中包含保留字符'$'

#### 数据库
在MongoDB中,多个文档组成集合,而多个集合可以组成数据库。数据库最终会变成文件系统里的文件,而数据库名就是相应的文件名。
- 数据库名不能是空字符串("")
- 基本上,数据库名只能使用ASCII中的字母和数字
- 数据库名区分大小写
- 数据库名最多为64字节

### MongoDB运行
运行mongod命令,启动数据库服务器:：
```mongo
mongod --dbpath /创建的数据目录
```
![image](https://i.niupic.com/images/2017/10/11/Zjk8Lb.png)  
运行mongo启动shell：
```mongo
mongo
```

### MongoDB数据格式
- null用于表示空值或者不存在的字段
- 布尔类型：true和false
- 数值
- 字符串
- 日期
- 正则表达式
- 数组
- 内嵌文档
- 对象id：一个12字节的ID,是文档的唯一标识
- 二进制数据：如果要将非UTF-8字
符保存到数据库中,二进制数据是唯一的方式
- 代码：查询和文档中可以包括任意JavaScript代码

### 使用MongoDB Shell
- 通过--nodb参数启动shell,启动时就不会连接任何数据库
- 启动之后,需要连接到想要的mongod：
```
conn = new Mongo("some-host:30000")
db = conn.getDB("myDB")
```
- 帮助文档：help
- 数据库级别的帮助：db.数据库.help()

MongoDB一些常用命令：
- 查看db当前指向哪个数据库：db
- 选择数据库：use 所选择数据库
- 将一个文档添加到集合中：db.集合.insert(文档)
- 查看数据库可用调用集合：db.数据库.find()
- 查看一个文档：db.数据库.findOne()
- 更新：db.数据库.update(匹配待
更新的文档,新的文档)
- 将文档从数据库中删除：db.数据库.remove(接受一个作为限定条件的文档作为参数)

### 创建、更新和删除文档
#### 插入并保存文档
- 向目标集合插入一个文档：
```
db.collection.insert({"bar" : "baz"})
```
- 向集合中插入多个文档，将一个文档数组作为参数：
```
db.collection.insert([{"_id" : 0}, {"_id" : 1}, {"_id" : 2}])
```
#### 删除文档
删除数据是永久性的,不能撤销,也不能恢复。
```
db.collection.remove(接受一个作为限定条件的文档作为参数)
```
#### 更新文档
```
db.collection.update(匹配待更新的文档,新的文档)
```
通过"_id"建立索引,使用"_id"作为查询条件比使用随机字段速度更快。

### 使用修改器
通常文档只会有一部分要更新。可以使用原子性的更新修改器，指定对文档中的某些字段进行更新。例如:
- "$set"用来指定一个字段的值。如果这个字段不存在,则创建它。
```
db.users.update({"_id" : ObjectId("4b253b067525f35f94b60a31")},{"$set" : {"favorite book" : "War and Peace"}})
```
- "$inc"修改器用来增加已有键的值,或者该键不存在那就创建一个。  
"$inc"键的值必须为数字。不能使用字符串、数组或其他非数字的值。
```
db.games.update({"game" : "pinball", "user" : "joe"},{"$inc" : {"score" : 10000}})
```

### 游标
数据库使用游标返回find的执行结果。客户端对游标的实现通常能够对最终结果进行有效的控制。可以限制结果的数量,略过部分结果,根据任意键按任意顺序的组合对结果进行各种排序,或者是执行其他一些强大的操作。
- 要迭代结果,可以使用游标的next方法
- 要限制结果数量,可在find后使用limit函数
- 要略过前n个匹配的文档,然后返回余下的文档,使用skip(n)
- sort接受一个对象作为参数,这个对象是一组键/值对,键对应文档的键名,值代表排序的方向。排序方向可以是1(升序)或者-1(降序)

### 索引
数据库索引与书籍的索引类似。不使用索引的查询称为全表扫描,应该尽量避免全表扫描,因为对于大集合来说,全表扫描的效率非常低。  
尝试在username字段上创建一个索引:
```
db.users.ensureIndex({"username" : 1})
```
使用了索引的查询几乎可以瞬间完成,然而,使用索引是有代价的:对于添加的每一个索引,每次写操作(插入、更新、删除)都将耗费更多的时间。这是因为,当数据发生变动时,MongoDB不仅要更新文档,还要更新集合上的所有索引。
#### 复合索引
如果查询中有多个排序方向或者查询条件
中有多个键,这个索引就会非常有用。复合索引就是一个建立在多个字段上的索引。
```
db.users.ensureIndex({"age" : 1, "username" : 1})
```

### 固定集合
MongoDB中的“普通”集合是动态创建的,而且可以自动增长以容纳更多的数据。MongoDB中还有另一种不同类型的集合,叫做固定集合,固定集合需要事先创建好,而且它的大小是固定的。  
创建固定集合:
```
db.createCollection("my_collection", {"capped" : true, "size" : 100000});
```

### 启动和停止MongoDB
执行mongod程序即可启动MongoDB服务器,在命令行中运行mongod --help可列出这些选项:
- --dbpath  
指定一个目录为数据目录。mongod启动时,会在其数据目录中创建一个mongod.lock文件,以阻止其他mongod进程使用此数据目录。
- --port  
用以指定服务器监听的端口号。mongod默认占用27017端口。
- --fork  
启用此选项以调用fork创建子进程,在后台运行MongoDB。
- --logpath  
所有输出信息会被发送至指定文件,而非在命令行上输出。除--logpath选项外,建议使用--logappend选项。
- --directoryperdb  
启用该选项可将每个数据库存放在单独的目录中。
- --config  
额外加载配置文件,未在命令行中指定的选项将使用配置文件中的参数。  
关闭运行中的服务器,最简洁的方法是使用shutdown命令：
```
db.shutdownServer()
```